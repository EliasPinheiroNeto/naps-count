<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üò¥ Contador de Cochilos</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #8b95c9 0%, #9ca3b8 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      width: 100%;
    }

    h1 {
      text-align: center;
      color: white;
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    #list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .nap-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .nap-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .nap-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
    }

    .nap-emoji {
      font-size: 2.5rem;
      filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
    }

    .nap-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .nap-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
    }

    .nap-count {
      font-size: 0.9rem;
      color: #718096;
      font-weight: 500;
    }

    .nap-total {
      font-size: 2rem;
      font-weight: 700;
      color: #7c88c4;
      margin-right: 1rem;
    }

    .nap-button {
      background: linear-gradient(135deg, #8b95c9 0%, #9ca3b8 100%);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.75rem 1.25rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .nap-button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .nap-button:active {
      transform: scale(0.95);
    }

    .nap-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .edit-button {
      background: transparent;
      color: #64748b;
      border: 2px solid #cbd5e0;
      border-radius: 4px;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      white-space: nowrap;
    }

    .edit-button:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
      color: #475569;
      transform: translateY(-1px);
    }

    .edit-button:active {
      transform: scale(0.95);
    }

    .edit-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f1f5f9;
      border-color: #cbd5e0;
      transform: none;
    }

    .button-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .loading {
      text-align: center;
      color: white;
      font-size: 1.2rem;
    }

    .format-button {
      background: white;
      color: #8b95c9;
      border: none;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin: 0 auto 2rem auto;
      max-width: 300px;
      width: 100%;
    }

    .format-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      background: #f8f9ff;
    }

    .format-button:active {
      transform: scale(0.98);
    }

    .format-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .formatted-text {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .formatted-text.show {
      display: block;
    }

    .formatted-text h3 {
      color: #2d3748;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .formatted-text pre {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 4px;
      padding: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 0.95rem;
      color: #2d3748;
      line-height: 1.6;
    }

    @keyframes napAnimation {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }

    .nap-card.animating {
      animation: napAnimation 0.5s ease;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 2rem;
      }

      .nap-card {
        padding: 1rem;
        flex-wrap: wrap;
      }

      .nap-name {
        font-size: 1.1rem;
      }

      .nap-total {
        font-size: 1.5rem;
      }

      .button-group {
        width: 100%;
        margin-top: 1rem;
        justify-content: stretch;
      }

      .nap-button,
      .edit-button {
        flex: 1;
        padding: 0.6rem 0.8rem;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üò¥ Contador de Cochilos</h1>
    <button class="format-button" onclick="generateWhatsAppFormat()">
      <span>üìã</span>
      <span>Gerar formata√ß√£o para zap</span>
    </button>
    <div id="list" class="loading">Carregando...</div>
    <div id="formatted-output" class="formatted-text">
      <h3>üì± Texto formatado para WhatsApp</h3>
      <pre id="formatted-content"></pre>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://plpwjsaytumxjxjetuvh.supabase.co",
      "sb_publishable_MUvRVK_dU-hgQ4sVzmHkaw_PjnpQzsk"
    );

    async function load() {
      const { data } = await supabase.from("naps").select("*").order("total", { ascending: false });
      
      if (!data || data.length === 0) {
        document.getElementById("list").innerHTML = '<p style="color: white; text-align: center;">Nenhum cochilo registrado ainda!</p>';
        return;
      }

      document.getElementById("list").innerHTML = data.map((u, index) => {
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const emoji = index < 3 ? medals[index] : 'üò¥';
        const plural = u.total === 1 ? 'cochilo' : 'cochilos';
        
        return `
          <div class="nap-card" data-name="${u.name}">
            <div class="nap-info">
              <div class="nap-emoji">${emoji}</div>
              <div class="nap-details">
                <div class="nap-name">${u.name}</div>
                <div class="nap-count">${u.total} ${plural}</div>
              </div>
            </div>
            <div class="nap-total">${u.total}</div>
            <div class="button-group">
              <button class="edit-button" onclick="editNap('${u.name}', ${u.total})" title="Corrigir a contagem manualmente">
                <span>‚úèÔ∏è</span>
                <span>Editar</span>
              </button>
              <button class="nap-button" onclick="nap('${u.name}')" title="Adicionar +1 cochilo">
                <span>+</span>
                <span>Cochilo</span>
              </button>
            </div>
          </div>
        `;
      }).join("");
    }

    function disableAllButtons() {
      document.querySelectorAll('button').forEach(btn => btn.disabled = true);
    }

    function enableAllButtons() {
      document.querySelectorAll('button').forEach(btn => btn.disabled = false);
    }

    window.nap = async (name) => {
      disableAllButtons();
      
      const card = document.querySelector(`[data-name="${name}"]`);
      if (card) {
        card.classList.add('animating');
        setTimeout(() => card.classList.remove('animating'), 500);
      }
      
      try {
        await supabase.rpc("increment_nap", { username: name });
        await load();
      } finally {
        enableAllButtons();
      }
    }

    window.editNap = async (name, currentTotal) => {
      const newTotal = prompt(`Corrigir contagem de ${name}\nContagem atual: ${currentTotal}\n\nDigite a nova contagem:`, currentTotal);
      
      if (newTotal === null) return; // Cancelado
      
      const parsed = parseInt(newTotal, 10);
      
      if (isNaN(parsed) || parsed < 0) {
        alert('Por favor, digite um n√∫mero v√°lido maior ou igual a zero.');
        return;
      }
      
      disableAllButtons();
      
      try {
        await supabase.rpc("set_nap", {
          username: name,
          new_total: parsed
        });
        
        await load();
      } finally {
        enableAllButtons();
      }
    }

    window.generateWhatsAppFormat = async () => {
      disableAllButtons();
      
      try {
        const { data } = await supabase.from("naps").select("*").order("total", { ascending: false });
        
        if (!data || data.length === 0) {
          alert('N√£o h√° dados para gerar!');
          return;
        }
        
        let text = '';
        let total = 0;
        
        data.forEach(person => {
          const napCount = person.total;
          const napEmojis = 'üí§'.repeat(napCount); // 1 emoji a cada 2 cochilos
          text += `${person.name}: ${napEmojis} \n`;
          total += napCount;
        });
        
        text += `\nTotal: ${total}`;
        
        // Exibir o texto formatado na p√°gina
        const outputElement = document.getElementById('formatted-output');
        const contentElement = document.getElementById('formatted-content');
        contentElement.textContent = text;
        outputElement.classList.add('show');
        
        // Copiar para clipboard
        try {
          await navigator.clipboard.writeText(text);
          alert('‚úÖ Texto copiado para a √°rea de transfer√™ncia!\n\nCole no WhatsApp.');
        } catch (err) {
          // Fallback para navegadores que n√£o suportam clipboard API
          const textarea = document.createElement('textarea');
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          alert('‚úÖ Texto copiado para a √°rea de transfer√™ncia!\n\nCole no WhatsApp.');
        }
      } finally {
        enableAllButtons();
      }
    }

    load();
  </script>
</body>
</html>
